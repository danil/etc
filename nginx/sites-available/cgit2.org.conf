# git2.kutkevich.org.

# cgit FastCGI cluster.
# Listening from 127.0.0.1:62000.
upstream git2_kutkevich_org_cluster {
    server 127.0.0.1:62002;
    server 127.0.0.1:62003;
}

server {
    listen       80;
    server_name  git2.kutkevich.org;
    root         /var/www/cgit/htdocs;
    access_log   /var/log/nginx/git2.kutkevich.org.access_log;
    error_log    /var/log/nginx/git2.kutkevich.org.error_log info;

    # This rewrites all the requests to the maintenance.html page
    # if it exists. This is for capistrano's disable web task.
    if (-f $document_root/maintenance.html) {
        rewrite ^(.*)$ /maintenance.html last;
        break;
    }

    # Serve favicon.
    location = /kutkevich_org.png {
        root /var/www/cgit/htdocs;
        expires 30d;
    }

    # Serve static files.
    location ~* ^.+\.(txt)$ {
        root /var/www/cgit/htdocs;
        expires 30d;
    }

    # Serve cgit assets.
    location ~* ^.+\.(png|css)$ {
        root /var/www/cgit/htdocs/cgit;
        expires 30d;
    }

    # Proxy everything else to cgit FastCGI cluster.
    location / {
        auth_basic            "Private Git repositories";
        auth_basic_user_file  /var/www/cgit/.htpasswd;
        rewrite ^/$ /cgit.cgi break;
        rewrite ^/(.+)$ /cgit.cgi/$1 break;
        fastcgi_pass  git2_kutkevich_org_cluster;
        fastcgi_index  /;
        fastcgi_param  DOCUMENT_ROOT    /var/www/cgit/cgi-bin;
        fastcgi_param  SCRIPT_FILENAME  /var/www/cgit/cgi-bin/cgit.cgi;
        fastcgi_param  CGIT_CONFIG  "/etc/cgitrc.git2.kutkevich.org";
        fastcgi_param  QUERY_STRING  $query_string;
        fastcgi_param  REQUEST_METHOD  $request_method;
        fastcgi_param  CONTENT_TYPE  $content_type;
        fastcgi_param  CONTENT_LENGTH  $content_length;
        fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;
        fastcgi_param  SERVER_SOFTWARE  nginx;
        fastcgi_param  SCRIPT_NAME  $fastcgi_script_name;
        fastcgi_param  REQUEST_URI  $request_uri;
        fastcgi_param  DOCUMENT_URI  $document_uri;
        fastcgi_param  DOCUMENT_ROOT  $document_root;
        fastcgi_param  SERVER_PROTOCOL  $server_protocol;
        fastcgi_param  REMOTE_ADDR  $remote_addr;
        fastcgi_param  REMOTE_PORT  $remote_port;
        fastcgi_param  SERVER_ADDR  $server_addr;
        fastcgi_param  SERVER_PORT  $server_port;
        fastcgi_param  SERVER_NAME  $server_name;
    }
}
